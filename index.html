<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚æ–‡ä»¶å…¥å£ç¶²</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #334155; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        
        /* å°è¦½åˆ— */
        .nav { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; gap: 5px; }
        .nav button { border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 1rem; }
        .nav button.active { background: var(--primary); color: white; }
        .nav button.inactive { background: transparent; color: #64748b; }
        .nav button.inactive:hover { background: #f1f5f9; }

        /* å¡ç‰‡å®¹å™¨ */
        .card { display: none; width: 100%; max-width: 600px; background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card.show { display: block; animation: slideUp 0.3s ease-out; }
        
        h2 { margin-top: 0; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* è¡¨å–® */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { background: #1d4ed8; }
        .btn-main:disabled { background: #94a3b8; cursor: not-allowed; }

        /* åˆ—è¡¨é …ç›® */
        .doc-item { border: 1px solid #e2e8f0; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; background: #fff; transition: 0.2s; }
        .doc-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .doc-info h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .doc-info p { margin: 0; font-size: 0.9rem; color: #64748b; }

        /* æŒ‰éˆ•ç¾¤ */
        .actions { display: flex; gap: 8px; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; }
        .btn-preview { background: #eff6ff; color: var(--primary); }
        .btn-preview:hover { background: #dbeafe; }
        .btn-download { background: #f0fdf4; color: #166534; }
        .btn-download:hover { background: #dcfce7; }

        /* é è¦½ Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { width: 90%; height: 90%; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 24px; cursor: pointer; border: none; background: none; color: #64748b; }
        iframe { flex: 1; border: none; width: 100%; background: #f1f5f9; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="nav">
        <button id="tabDoctor" class="active" onclick="switchRole('doctor')">ğŸ‘¨â€âš•ï¸ é†«å¸«ç«¯</button>
        <button id="tabPatient" class="inactive" onclick="switchRole('patient')">ğŸ¤’ ç—…äººç«¯</button>
    </div>

    <div id="viewDoctor" class="card show">
        <h2>ğŸ“¤ ä¸Šå‚³æª¢æŸ¥å ±å‘Š</h2>
        <div style="background:#eff6ff; padding:12px; border-radius:8px; margin-bottom:20px; color:#1e40af; font-size:0.9rem;">
            ç•¶å‰é†«å¸«: <b>MIT1</b> (ID: 5)
        </div>
        
        <div class="form-group">
            <label>ç—…äºº FHIR ID</label>
            <input type="text" id="uploadPatientId" value="12345" placeholder="è¼¸å…¥ç—…äºº ID">
        </div>
        <div class="form-group">
            <label>é¸æ“‡ PDF æª”æ¡ˆ</label>
            <input type="file" id="fileInput" accept="application/pdf">
        </div>

        <button class="btn-main" id="btnUpload" onclick="handleUpload()">ç¢ºèªä¸Šå‚³</button>
        <div id="uploadStatus" style="margin-top:15px; text-align:center;"></div>
    </div>

    <div id="viewPatient" class="card">
        <h2>ğŸ—‚ï¸ æˆ‘çš„å¥åº·å­˜æ‘º</h2>
        <div class="form-group">
            <label>æ‚¨çš„ Patient ID</label>
            <input type="text" id="myPatientId" value="12345">
        </div>
        <button class="btn-main" style="background:#475569;" onclick="fetchDocuments()">æŸ¥è©¢å ±å‘Š</button>

        <div id="docList" style="margin-top:25px;">
            <p style="text-align:center; color:#94a3b8;">è«‹é»æ“ŠæŸ¥è©¢ä»¥è¼‰å…¥è³‡æ–™...</p>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">æ–‡ä»¶é è¦½</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <iframe id="pdfViewer" src=""></iframe>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬ Session
        const CURRENT_DOCTOR = { id: "5", name: "MIT1" };

        // UI åˆ‡æ›é‚è¼¯
        function switchRole(role) {
            document.querySelectorAll('.nav button').forEach(b => b.className = 'inactive');
            document.querySelectorAll('.card').forEach(c => c.classList.remove('show'));

            if (role === 'doctor') {
                document.getElementById('tabDoctor').className = 'active';
                document.getElementById('viewDoctor').classList.add('show');
            } else {
                document.getElementById('tabPatient').className = 'active';
                document.getElementById('viewPatient').classList.add('show');
                fetchDocuments(); // åˆ‡æ›æ™‚è‡ªå‹•æŸ¥è©¢
            }
        }

        // åŠŸèƒ½: ä¸Šå‚³æª”æ¡ˆ
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const patientId = document.getElementById('uploadPatientId').value;
            const btn = document.getElementById('btnUpload');
            const status = document.getElementById('uploadStatus');

            if (!fileInput.files[0]) return alert("è«‹é¸æ“‡æª”æ¡ˆ");

            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";
            status.innerHTML = "æ­£åœ¨ä¸Šå‚³è‡³ GitHub ä¸¦å¯«å…¥ FHIR...";

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('patientId', patientId);
            formData.append('practitionerId', CURRENT_DOCTOR.id);
            formData.append('practitionerName', CURRENT_DOCTOR.name);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.success) {
                    status.innerHTML = `<span style="color:green">âœ… æˆåŠŸ! FHIR Resource ID: ${data.id}</span>`;
                    fileInput.value = '';
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                status.innerHTML = `<span style="color:red">âŒ å¤±æ•—: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¢ºèªä¸Šå‚³";
            }
        }

        // åŠŸèƒ½: æŸ¥è©¢ç—…äººæ–‡ä»¶
        async function fetchDocuments() {
            const patientId = document.getElementById('myPatientId').value;
            const listDiv = document.getElementById('docList');
            listDiv.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';

            try {
                const res = await fetch(`/api/patient/${patientId}/documents`);
                const docs = await res.json();

                if (docs.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center; color:#64748b;">æŸ¥ç„¡è³‡æ–™</p>';
                    return;
                }

                let html = '';
                docs.forEach(doc => {
                    const dateStr = new Date(doc.date).toLocaleString();
                    const previewLink = `${doc.downloadUrl}?preview=true`;
                    
                    html += `
                        <div class="doc-item">
                            <div class="doc-info">
                                <h4>ğŸ“„ ${doc.title}</h4>
                                <p>é†«å¸«: ${doc.author} | æ™‚é–“: ${dateStr}</p>
                            </div>
                            <div class="actions">
                                <button onclick="openPreview('${doc.title}', '${previewLink}')" class="btn-sm btn-preview">
                                    ğŸ‘ï¸ é è¦½
                                </button>
                                <a href="${doc.downloadUrl}" target="_blank" class="btn-sm btn-download">
                                    â¬‡ ä¸‹è¼‰
                                </a>
                            </div>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
            } catch (err) {
                listDiv.innerHTML = '<p style="text-align:center; color:red;">ä¼ºæœå™¨é€£ç·šéŒ¯èª¤</p>';
            }
        }

        // Modal æ§åˆ¶
        function openPreview(title, url) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('pdfViewer').src = url;
            document.getElementById('previewModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('pdfViewer').src = ''; // æ¸…é™¤ src é˜²æ­¢èƒŒæ™¯ç¹¼çºŒä¸‹è¼‰
        }

        // é»æ“Šé®ç½©é—œé–‰
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') closeModal();
        });
    </script>
</body>
</html>