<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚æ–‡ä»¶å…¥å£ç¶² (å®‰å…¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #334155; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        
        .nav { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; gap: 5px; }
        .nav button { border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 1rem; }
        .nav button.active { background: var(--primary); color: white; }
        .nav button.inactive { background: transparent; color: #64748b; }
        
        .card { display: none; width: 100%; max-width: 600px; background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card.show { display: block; animation: slideUp 0.3s ease-out; }
        
        h2 { margin-top: 0; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { background: #1d4ed8; }
        .btn-main:disabled { background: #94a3b8; cursor: not-allowed; }

        .doc-item { border: 1px solid #e2e8f0; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .doc-info h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .doc-info p { margin: 0; font-size: 0.9rem; color: #64748b; }

        .actions { display: flex; gap: 8px; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; }
        .btn-preview { background: #eff6ff; color: var(--primary); }
        .btn-download { background: #f0fdf4; color: #166534; }

        /* Token è¼¸å…¥å€å¡Šç‰¹åˆ¥æ¨£å¼ */
        .token-box { background: #fff7ed; border: 1px solid #fdba74; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .token-box label { color: #c2410c; }
        .token-box input { border-color: #fdba74; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { width: 90%; height: 90%; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 24px; cursor: pointer; border: none; background: none; color: #64748b; }
        iframe { flex: 1; border: none; width: 100%; background: #f1f5f9; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div style="width: 100%; max-width: 600px;">
        <div class="token-box">
            <label>ğŸ”‘ è«‹è¼¸å…¥æ‚¨çš„ GitHub Token</label>
            <input type="password" id="apiToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <small style="color:#9a3412; display:block; margin-top:5px;">
                æ³¨æ„ï¼šæ­¤ Token åƒ…ç”¨æ–¼æœ¬æ¬¡ç€è¦½å™¨é€£ç·šï¼Œä¸æœƒè¢«å„²å­˜ã€‚è«‹æ”¾å¿ƒå¡«å…¥ã€‚
            </small>
        </div>
    </div>

    <div class="nav">
        <button id="tabDoctor" class="active" onclick="switchRole('doctor')">ğŸ‘¨â€âš•ï¸ é†«å¸«ç«¯</button>
        <button id="tabPatient" class="inactive" onclick="switchRole('patient')">ğŸ¤’ ç—…äººç«¯</button>
    </div>

    <div id="viewDoctor" class="card show">
        <h2>ğŸ“¤ ä¸Šå‚³æª¢æŸ¥å ±å‘Š</h2>
        
        <div style="background:#eff6ff; padding:12px; border-radius:8px; margin-bottom:20px; color:#1e40af; font-size:0.9rem;">
            ç•¶å‰é†«å¸«: <b>MIT1</b> (ID: 5)
        </div>
        
        <div class="form-group">
            <label>ç—…äºº FHIR ID</label>
            <input type="text" id="uploadPatientId" value="12345" placeholder="è¼¸å…¥ç—…äºº ID">
        </div>
        <div class="form-group">
            <label>é¸æ“‡ PDF æª”æ¡ˆ</label>
            <input type="file" id="fileInput" accept="application/pdf">
        </div>

        <button class="btn-main" id="btnUpload" onclick="handleUpload()">ç¢ºèªä¸Šå‚³</button>
        <div id="uploadStatus" style="margin-top:15px; text-align:center;"></div>
    </div>

    <div id="viewPatient" class="card">
        <h2>ğŸ—‚ï¸ æˆ‘çš„å¥åº·å­˜æ‘º</h2>
        <div class="form-group">
            <label>æ‚¨çš„ Patient ID</label>
            <input type="text" id="myPatientId" value="12345">
        </div>
        <button class="btn-main" style="background:#475569;" onclick="fetchDocuments()">æŸ¥è©¢å ±å‘Š</button>

        <div id="docList" style="margin-top:25px;">
            <p style="text-align:center; color:#94a3b8;">è«‹é»æ“ŠæŸ¥è©¢ä»¥è¼‰å…¥è³‡æ–™...</p>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">æ–‡ä»¶é è¦½</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <iframe id="pdfViewer" src=""></iframe>
        </div>
    </div>

    <script>
        // è¨­å®šå€ (æ³¨æ„ï¼šé€™è£¡ä¸å†åŒ…å« Token)
        const CONFIG = {
            FHIR_BASE_URL: 'https://hapi.fhir.org/baseR4',
            GITHUB_USER: 'chiphat102',
            GITHUB_REPO: 'DocumentReference-test',
            GITHUB_API_VER: '2022-11-28'
        };

        const CURRENT_DOCTOR = { id: "5", name: "MIT1" };

        // å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„ Token
        function getUserToken() {
            const token = document.getElementById('apiToken').value.trim();
            if (!token) {
                alert("âš ï¸ è«‹å…ˆåœ¨ä¸Šæ–¹æ©˜è‰²æ¡†æ¡†è¼¸å…¥æ‚¨çš„ GitHub Tokenï¼");
                return null;
            }
            return token;
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateStoragePath(originalName) {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const safeName = originalName.replace(/[^a-zA-Z0-9.]/g, "_");
            return `uploads/${year}/${month}/${Date.now()}_${uuidv4().substring(0,8)}_${safeName}`;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function switchRole(role) {
            document.querySelectorAll('.nav button').forEach(b => b.className = 'inactive');
            document.querySelectorAll('.card').forEach(c => c.classList.remove('show'));

            if (role === 'doctor') {
                document.getElementById('tabDoctor').className = 'active';
                document.getElementById('viewDoctor').classList.add('show');
            } else {
                document.getElementById('tabPatient').className = 'active';
                document.getElementById('viewPatient').classList.add('show');
                // åˆ‡æ›åˆ°ç—…äººä¸è‡ªå‹•æŸ¥è©¢ï¼Œé¿å…æ²’ Token å ±éŒ¯
            }
        }

        // [ä¸Šå‚³] ä¸»æµç¨‹
        async function handleUpload() {
            const token = getUserToken(); // å–å¾— Token
            if (!token) return;

            const fileInput = document.getElementById('fileInput');
            const patientId = document.getElementById('uploadPatientId').value;
            const btn = document.getElementById('btnUpload');
            const status = document.getElementById('uploadStatus');

            if (!fileInput.files[0]) return alert("è«‹é¸æ“‡æª”æ¡ˆ");

            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";
            status.innerHTML = "æ­£åœ¨è®€å–æª”æ¡ˆ...";

            try {
                const file = fileInput.files[0];
                const contentBase64 = await fileToBase64(file);
                const storagePath = generateStoragePath(file.name);

                status.innerHTML = "ä¸Šå‚³è‡³ GitHub...";
                const githubUrl = `https://api.github.com/repos/${CONFIG.GITHUB_USER}/${CONFIG.GITHUB_REPO}/contents/${storagePath}`;
                
                // ä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„ Token
                const ghResponse = await axios.put(githubUrl, {
                    message: `Medical Upload: ${storagePath}`,
                    content: contentBase64
                }, {
                    headers: {
                        'Authorization': `Bearer ${token}`, // é€™è£¡è®Šäº†
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': CONFIG.GITHUB_API_VER
                    }
                });
                
                const storageUrl = ghResponse.data.content.url; 

                status.innerHTML = "å¯«å…¥ FHIR Server...";
                
                const fhirResource = {
                    resourceType: "DocumentReference",
                    status: "current",
                    docStatus: "final",
                    type: {
                        coding: [{ system: "http://loinc.org", code: "34117-2", display: "History and physical note" }],
                        text: "é–€è¨ºæª¢æŸ¥å ±å‘Š"
                    },
                    subject: { reference: `Patient/${patientId}` },
                    author: [{ reference: `Practitioner/${CURRENT_DOCTOR.id}`, display: CURRENT_DOCTOR.name }],
                    date: new Date().toISOString(),
                    content: [{
                        attachment: {
                            contentType: file.type,
                            url: storageUrl,
                            size: file.size,
                            title: file.name,
                            creation: new Date().toISOString()
                        }
                    }]
                };

                const fhirResponse = await axios.post(
                    `${CONFIG.FHIR_BASE_URL}/DocumentReference`, 
                    fhirResource, 
                    { headers: { 'Content-Type': 'application/fhir+json' } }
                );

                status.innerHTML = `<span style="color:green">âœ… æˆåŠŸ! FHIR ID: ${fhirResponse.data.id}</span>`;
                fileInput.value = '';

            } catch (err) {
                console.error(err);
                if(err.response && err.response.status === 401) {
                    alert("Token ç„¡æ•ˆï¼è«‹æª¢æŸ¥æ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–å·²éæœŸ");
                }
                status.innerHTML = `<span style="color:red">âŒ å¤±æ•—: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¢ºèªä¸Šå‚³";
            }
        }

        // [æŸ¥è©¢] ä¸»æµç¨‹
        async function fetchDocuments() {
            // æ³¨æ„ï¼šæŸ¥è©¢æ–‡ä»¶åˆ—è¡¨æœ¬èº«ä¸éœ€è¦ GitHub Token (å› ç‚ºæ˜¯æŸ¥ FHIR)
            // ä½†ç‚ºäº†ä¸‹è¼‰é è¦½ï¼Œæˆ‘å€‘é‚„æ˜¯æœƒéœ€è¦å®ƒã€‚
            
            const patientId = document.getElementById('myPatientId').value;
            const listDiv = document.getElementById('docList');
            listDiv.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';

            try {
                const url = `${CONFIG.FHIR_BASE_URL}/DocumentReference?subject=Patient/${patientId}&_sort=-date`;
                const response = await axios.get(url);
                const bundle = response.data;

                if (!bundle.entry || bundle.entry.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center; color:#64748b;">æŸ¥ç„¡è³‡æ–™</p>';
                    return;
                }

                let html = '';
                for (const entry of bundle.entry) {
                    const doc = entry.resource;
                    const att = doc.content[0].attachment;
                    const dateStr = new Date(doc.date).toLocaleString();
                    const title = att.title || 'æœªå‘½åæ–‡ä»¶';
                    const author = doc.author ? doc.author[0].display : 'æœªçŸ¥';
                    const fileUrl = att.url; 

                    html += `
                        <div class="doc-item">
                            <div class="doc-info">
                                <h4>ğŸ“„ ${title}</h4>
                                <p>é†«å¸«: ${author} | æ™‚é–“: ${dateStr}</p>
                            </div>
                            <div class="actions">
                                <button onclick="handleFileAction('${fileUrl}', '${doc.content[0].attachment.contentType}', 'preview')" class="btn-sm btn-preview">
                                    ğŸ‘ï¸ é è¦½
                                </button>
                                <button onclick="handleFileAction('${fileUrl}', '${doc.content[0].attachment.contentType}', 'download')" class="btn-sm btn-download">
                                    â¬‡ ä¸‹è¼‰
                                </button>
                            </div>
                        </div>
                    `;
                }
                listDiv.innerHTML = html;

            } catch (err) {
                console.error(err);
                listDiv.innerHTML = '<p style="text-align:center; color:red;">FHIR Server é€£ç·šéŒ¯èª¤</p>';
            }
        }

        // [ä¸‹è¼‰/é è¦½]
        async function handleFileAction(apiUrl, contentType, action) {
            const token = getUserToken(); // éœ€è¦ Token æ‰èƒ½ä¸‹è¼‰
            if (!token) return;

            try {
                const response = await axios.get(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`, // ä½¿ç”¨è¼¸å…¥çš„ Token
                        'Accept': 'application/vnd.github.v3.raw'
                    },
                    responseType: 'blob'
                });

                const blob = new Blob([response.data], { type: contentType });
                const blobUrl = window.URL.createObjectURL(blob);

                if (action === 'preview') {
                    document.getElementById('modalTitle').innerText = "æ–‡ä»¶é è¦½";
                    document.getElementById('pdfViewer').src = blobUrl;
                    document.getElementById('previewModal').style.display = 'flex';
                } else {
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = 'downloaded_file.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                }

            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèª Token æ­£ç¢ºä¸”æ“æœ‰ Repo æ¬Šé™");
            }
        }

        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('pdfViewer').src = '';
        }
        
        window.onclick = function(event) {
            if (event.target == document.getElementById('previewModal')) {
                closeModal();
            }
        }
    </script>
</body>
</html>

